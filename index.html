<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo dei Piatti Italiani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (will be populated by Canvas environment)
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.__firebase_config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.firebaseApp = initializeApp(window.__firebase_config);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);

        // Exporting for use in main script block
        window.firebase = {
            auth: window.auth,
            db: window.db,
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            onAuthStateChanged: onAuthStateChanged,
            setDoc: setDoc,
            collection: collection,
            query: query,
            onSnapshot: onSnapshot,
            doc: doc,
            deleteDoc: deleteDoc
        };
    </script>

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #fdf7f1;
            color: #4a4a4a;
        }
        .title-font {
            font-family: 'Lora', serif;
        }
        .bracket-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem; /* Reduced padding for mobile */
            overflow-x: auto;
            min-height: 600px;
        }
        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            min-width: 180px; /* Adjusted min-width for responsiveness */
            width: 220px; /* Default width for larger screens */
            margin: 0 8px; /* Reduced margin for mobile */
        }

        @media (min-width: 768px) { /* Medium screens and up */
            .round {
                min-width: 250px;
                width: 250px;
                margin: 0 20px;
            }
        }

        .match {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 12px 0; /* Adjusted margin */
            flex-grow: 1;
        }
        .match-pair {
             display: flex;
             flex-direction: column;
             justify-content: center;
             background-color: #fff;
             border-radius: 8px;
             box-shadow: 0 2px 4px rgba(0,0,0,0.05);
             padding: 6px; /* Reduced padding */
             min-height: 70px; /* Reduced min-height */
        }
        .competitor {
            padding: 6px; /* Reduced padding */
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            margin: 2px 0; /* Reduced margin */
            text-transform: capitalize;
            font-size: 0.85rem; /* Adjusted font size */
        }
        @media (min-width: 768px) {
            .competitor {
                padding: 10px;
                margin: 5px 0;
                font-size: 1rem;
            }
        }

        .competitor:not(.winner):not(.loser):hover {
            background-color: #f0f8ff;
            border-color: #4a90e2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .competitor.winner {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            border-color: #4CAF50;
        }
        .competitor.loser {
            background-color: #fbe9e7;
            color: #9e9e9e;
            text-decoration: line-through;
            opacity: 0.7;
        }
        .competitor.placeholder {
            background-color: #f5f5f5;
            color: #bdbdbd;
            cursor: default;
            text-align: center;
        }
        .vs-separator {
            text-align: center;
            font-weight: bold;
            color: #d32f2f;
            font-family: 'Lora', serif;
            margin: 2px 0;
            font-size: 0.75rem; /* Adjusted font size */
        }
        @media (min-width: 768px) {
            .vs-separator {
                font-size: 1rem;
            }
        }
        .match-connector {
            position: absolute;
            right: -15px; /* Adjusted for smaller margins */
            top: 50%;
            width: 15px; /* Adjusted width */
            height: 2px;
            background-color: #bdbdbd;
        }
        .round-connector {
            position: absolute;
            right: -23px; /* Adjusted for smaller margins */
            width: 2px;
            background-color: #bdbdbd;
        }
        .final .match-connector, .final .round-connector {
            display: none;
        }
        .winner-trophy {
            text-align: center;
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold title-font text-red-800">Torneo dei Piatti Italiani</h1>
            <p class="text-lg text-gray-600 mt-2">Scegli il tuo piatto preferito in ogni scontro per incoronare il campione!</p>
            <p class="text-sm text-gray-500 mt-1" id="user-id-display"></p>
        </header>

        <!-- Loading Screen -->
        <div id="loading-screen" class="flex flex-col items-center justify-center min-h-[400px] bg-white p-8 rounded-lg shadow-lg hidden">
            <div class="spinner mb-4"></div>
            <p class="text-xl text-gray-700">Caricamento categorie...</p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="flex flex-col items-center justify-center min-h-[400px] bg-white p-8 rounded-lg shadow-lg hidden">
            <h2 class="text-3xl font-bold title-font text-red-700 mb-6">Configura il tuo Torneo</h2>
            
            <div class="mb-6 w-full max-w-sm">
                <label for="category-select" class="block text-gray-700 text-sm font-bold mb-2">Seleziona Categoria:</label>
                <select id="category-select" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100 border-gray-300">
                    <!-- Options populated by JavaScript -->
                </select>
            </div>

            <div class="mb-8 w-full max-w-sm">
                <label for="size-select" class="block text-gray-700 text-sm font-bold mb-2">Numero di Partecipanti:</label>
                <select id="size-select" class="shadow border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100 border-gray-300">
                    <option value="8">8</option>
                    <option value="16" selected>16</option>
                    <option value="32">32</option>
                    <option value="64">64</option>
                </select>
                <p id="size-warning" class="text-sm text-red-500 mt-2 hidden">Attenzione: Non ci sono abbastanza elementi per questa dimensione del torneo nella categoria selezionata.</p>
            </div>

            <button id="start-tournament-button" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 text-lg">Inizia Torneo</button>

            <hr class="my-8 w-full max-w-md border-t-2 border-gray-200">

            <h3 class="text-2xl font-bold title-font text-gray-700 mb-4">Genera Nuova Lista con AI ✨</h3>
            <div class="mb-4 w-full max-w-sm">
                <label for="ai-category-prompt" class="block text-gray-700 text-sm font-bold mb-2">Tipo di elementi da generare:</label>
                <input type="text" id="ai-category-prompt" placeholder="Es: città italiane, sport olimpici" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100 border-gray-300"/>
            </div>
            <button id="generate-list-button" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-purple-700 transition-colors duration-300">Genera Nuova Lista ✨</button>
            <p id="generate-feedback" class="text-sm mt-2 hidden"></p>
            <div id="generate-spinner" class="spinner mt-4 hidden"></div>
        </div>

        <!-- Tournament Container -->
        <div id="tournament-container" class="hidden">
            <main id="tournament-bracket" class="bracket-container">
                <!-- Le colonne del torneo verranno generate qui da JavaScript -->
            </main>

            <div id="winner-display" class="text-center mt-12"></div>
            
            <footer class="text-center mt-12">
                <button id="reset-button" class="bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-red-800 transition-colors duration-300">Ricomincia Torneo</button>
            </footer>
        </div>
    </div>

    <script>
        // Ensure Firebase is loaded before running main script
        window.addEventListener('load', async () => {
            if (typeof window.firebase === 'undefined') {
                console.error("Firebase SDK not loaded. Please ensure the module script runs correctly.");
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-500">Errore: Firebase non caricato. Ricarica la pagina.</p>';
                return;
            }

            const { auth, db, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setDoc, collection, query, onSnapshot, doc } = window.firebase;

            // --- DATA ---
            // Initial built-in data
            let dishData = {
                primi: [
                    "tagliatelle al ragu", "pasta e fagioli", "ravioli ricotta e spinaci", "riso patate e cozze",
                    "zuppa di pesce", "spaghetti alla puttanesca", "penne all'arrabbiata", "pasta patate e provola",
                    "lasagne al ragù", "risotto alla zucca", "gnocchi alla sorrentina", "spaghetti burro e parmigiano",
                    "risotto giallo", "canederli", "tortellini panna e prosciutto", "pennette con salmone",
                    "spaghetti con le vongole", "tortelli cremaschi", "pappa al pomodoro", "ribollita",
                    "cacio e pepe", "spaghetti aglio e olio", "cannelloni ricotta e spinaci", "spaghetti all'assassina",
                    "carbonara", "agnolotti", "linguine con astice", "tagliolini burro e limone",
                    "pappardelle al cinghiale", "pasta alla norma", "pasta al forno", "pici all'aglione",
                    "tortellini in brodo", "orechiette broccoli e alici", "velluttata di verdure", "spaghetti alla nerano",
                    "parmigiana di melanzane", "risotto ai funghi", "spaghetti con polpette", "anelletti al forno con ragù e piselli",
                    "trofie al pesto", "pasta con le sarde", "gnocchi alla romana", "zuppa di cipolle",
                    "spaghetti al pomodoro", "orecchiette cime di rapa", "tagliolini con tartufo", "stelline in brodo",
                    "amatriciana", "fusilli alla trapanese", "linguine al nero di seppia", "minestrone con crostini",
                    "pizzoccheri", "gricia", "gnocchi al gorgonzola", "pasta al tonno", "spazzle burro e salvia",
                    "pasta allo scoglio", "pasta e lenticchie", "spaghetti con la bottarga", "pasta ai peperoni cruschi"
                ].map(d => d.toLowerCase().trim()).filter(d => d),

                secondiEContorni: [
                    "Polpette al sugo", "Polpo e patate", "Calamari ripieni", "Polpettone", "Brasato", "Filetto al pepe verde",
                    "Pollo alla cacciatora", "Nervetti", "Vitello tonnato", "Saltimbocca", "Faraona ripiena", "Seppie in umido",
                    "Spezzatino", "Baccalà mantecato", "Cotechino bollito", "Stinco di maiale", "Fiorentina", "Scaloppine",
                    "Impepata di cozze", "Coniglio alla ligure", "Ossobuco alla milanese", "Orata al forno", "Bollito con salse",
                    "Anatra all'arancia", "Cotoletta alla milanese", "Costolette d'agnello", "Trippa alla romana", "Alici fritte",
                    "Fritto misto", "Grigliata di pesce", "Braciole al sugo", "Peperoni ripieni", "Polenta e cinghiale", "Cacciucco",
                    "Fagioli con le cotiche", "Fettine panate", "Arrosto di vitello", "Fegato alla veneziana", "Capesante gratinate",
                    "Stracotto d'asino", "Pollo arrosto", "Crocchette di patate", "Guancia di maiale brasata", "Lumache aglio e prezzemolo",
                    "Costine di maiale", "Verdure grigliate", "Salmone in crosta", "Merluzzo fritto", "Patate al forno", "Torta di patate",
                    "Purè di patate", "Carne alla pizzaiola", "Patatine fritte", "Polenta concia", "Ratatouille", "Carciofi alla giudia",
                    "Caponata", "Peperonata", "Funghi trifolati", "Finocchi gratinati", "Cipolle caramellate", "Frittata di cipolle",
                    "Zucca al forno", "Cicoria ripassata"
                ].map(d => d.toLowerCase().trim()).filter(d => d),

                dolci: [
                    "Tiramisù", "Cannolo siciliano", "Delizia al limone", "Sorbetto al limone", "Crostata alla marmellata",
                    "Torta caprese", "Cassata", "Torta pesca e amaretti", "Salame al cioccolato", "Pandoro", "Colomba",
                    "Bertolina", "Torta pere e cioccolato", "Mousse tre cioccolati", "Mele cotte con cannella", "Sfogliatella riccia",
                    "Strudel", "Maritozzo", "Seadas", "Panettone", "Pasticciotto leccese", "Zabaione", "Struffoli", "Millefoglie",
                    "Torta tenerina", "Zeppole", "Torta diplomatica", "Tortino al cioccolato", "Graffe", "Cartellate pugliesi",
                    "Ciambellone", "Chiacchiere / Frittelle", "Meringata", "Torta delle rose", "Castagnaccio", "Panna cotta",
                    "Semifreddo al caffè", "Bonet", "Pane dei morti", "Torta di mele", "Sospiri", "Torta paradiso",
                    "Torta ricotta e cioccolato", "Babà", "Tartufo (bianco/nero)", "Torrone", "Mostaccioli",
                    "Crostata di frutta con crema pasticcera", "Castagnole / Tortellli", "Piadina con la nutella", "Croccante alle mandorle",
                    "Torta della nonna", "Pastiera napoletana", "Torta fredda allo yogurt", "Panpepato", "Sbrisolona", "Zuppa inglese",
                    "Profiteroles", "Torta mimosa", "Gelato artigianale", "Torta cocco e cioccolato", "Creme caramel", "Torta alla carota"
                ].map(d => d.toLowerCase().trim()).filter(d => d),

                biscotti: [
                    "Macine", "Galletti", "Scacchieri", "Baiocchi al pistacchio", "Pan di stelle", "Baiocchi", "Oro Saiwa",
                    "Molinetti", "Abbracci", "Digestive", "Tarallucci", "Girotondi", "Nascondini", "Settembrini", "Campagnole",
                    "Batticuori", "Cuor di mela", "Pannocchie", "Ritornelli", "Pavesini", "Gocciole", "Canestrelli", "Rigoli",
                    "Gocciole dark/caramello", "Plasmon", "Tenerezze al limone", "Primizie", "Krumiri", "Ringo", "GranCereale",
                    "Buoni così", "Nonnine Doria", "Bucaneve", "Oreo", "Grisbì (nocciola, cioccolato, crema, limone)",
                    "Zuppalatte Colussi", "Nutella Biscuits", "Zalet", "Biscotti Atene", "Ancorauno Tre Marie",
                    "Wafer Loacker (cacao/latte)", "Butter cookie Royal Danish", "Gran Turchese", "Biscotti allo zenzero Ikea",
                    "Lotus", "Mikado", "Kinder Cards", "Ciambelle Balocco", "Cookies Milka", "Amaretti Balocco",
                    "Zuppole Balocco", "Girandole Balocco", "Sfogliatine Balocco", "OroCiok", "Savoiardi Balocco",
                    "Oswego Colussi", "Cantuccini"
                ].map(d => d.toLowerCase().trim().replace(/"/g, '')).filter(d => d),

                attori: [
                    "Brad Pitt", "Tom Cruise", "George Clooney", "Richard Gere", "Jake Gyllenhal", "Ryan Gosling",
                    "jamie foxx", "michael b jordan", "Tom Hardy", "Jacob Elordi", "javier bardem", "Elio Germano",
                    "Ben Affleck", "johnny depp", "Bradley Cooper", "Luca Marinelli", "Adrien Brody",
                    "Leonardo di Caprio", "Sam Caflin", "Alessandro Borghi", "Paul Newman", "Cilian Murphy",
                    "Robert Pattinson", "Jude Law", "James Deen", "Robert Downey Jr.", "Timothée Chalamet",
                    "robert redford", "Christian Bale", "Matthew McConnaguyeehgahgurnafdha", "Viggo Mortensen",
                    "Ashton Kutcher", "Hugh Jacckkkkmannn", "Henry Cavill", "Oscar Isaac", "Lee Pace",
                    "Matt Damon", "Aaron Taylor-Johnson", "Armie Hammer", "Jeremy White", "Sean Penn",
                    "Chris Hemsworth", "Harrison Ford", "Edward Norton", "Omar Sy", "Keanu Reeves",
                    "Chris Hemsword", "Bruce Willis", "Djimon Hounsou.", "Benicio Del Toro", "Adam Driver",
                    "Jason Statham", "Patrick Dempsey", "Vincent Cassel", "Jeffrey Dean Morgan", "Adam Brody",
                    "Benedict Cumberbatch", "Andrew Garfield", "Matt Bomer", "Ryan Reynolds"
                ].map(d => d.toLowerCase().trim().replace(/"/g, '')).filter(d => d),

                nomiStrani: [
                    "concetto vecchio", "cataldo Stragapede", "loris borro", "delfo bardelli", "Felicino Vaniglia",
                    "Nunziante Splendore", "Emilio Stancampiano", "carmelinda pietragalla", "salvatore arcadipane",
                    "catena de grande", "felice porto", "Maurizio Capezzuoli Ranchi", "Andrea Scozzafava",
                    "Leopoldo Matrangolo", "dora peto", "cristofaro colombo", "dino alexander protasoni",
                    "juan gerardo belen rossi", "Domenicantonio Sabetta", "Medardo Gabelli", "Roberto Grissino",
                    "basilio marascio", "enrica guastadisegni", "pasqualino indelicato", "hilary porro",
                    "Angelo Caimano", "Mariarca Bonaiuto", "Ascanio Bellopede", "sebastiano derelitto",
                    "bruno casadio", "umano teodori", "dennis volante", "Saverio Maniglia", "Marco Porcile",
                    "davide terrone", "raimondo capodicasa", "michelino cloroformio", "lupo gelsi",
                    "mattia joe venturelli", "Crisele Ariola", "Feliciano Bufalino", "Euplio Piccirillo",
                    "novella novelli", "alessandro pastormerlo", "antonio figarola", "giusy lembo",
                    "Loreto Fantozzi", "Olga Fungo", "Felice Spinello", "Floro Guarna", "dionigi volpe",
                    "andrea favagrossa", "yuri bombardi", "Melchiorre Candino", "Defendente Circoncisi",
                    "Felice Scoccimarro", "Loredano Guasina", "costanzo pungente", "ignazia giuseppa gelsomino",
                    "giangaleazzo ganzarolli", "Antonfranco Pasquale", "Regina Della Guerra", "Angelo Viavattene",
                    "ciro cipolletta", "fiorello cacau", "decimo galletti", "detalmo granzotto",
                    "Giorgio Meloni", "Omodeo Gianolo Paolo", "Eusachio Machera", "kevin testagrossa",
                    "iriza alma orofino", "vanna tagliavini", "bardilio puggioni", "Brando Benifei",
                    "Giuseppe Trombatore", "Immacolata Veloce", "demetrio cutrupi", "viola di domenicantonio",
                    "adriana degli effetti luciani", "gasparino facchinetti forlani", "Fiona Cacalli",
                    "Derek Vassallo", "Fabrizio Frinolli Puzzilli", "Antonangelo Casula", "Placido Recupero",
                    "Luca Sederino", "Pasqualino Fattaccio", "Letterio Grillo", "Berardino Tarallo", "V"
                ].map(d => d.toLowerCase().trim().replace(/"/g, '')).filter(d => d && d !== 'v')
            };
            
            const roundTitles = ["Ottavi di Finale", "Quarti di Finale", "Semifinali", "Finale"];

            // --- DOM Elements ---
            const loadingScreen = document.getElementById('loading-screen');
            const startScreen = document.getElementById('start-screen');
            const tournamentContainer = document.getElementById('tournament-container');
            const categorySelect = document.getElementById('category-select');
            const sizeSelect = document.getElementById('size-select');
            const startButton = document.getElementById('start-tournament-button');
            const resetButton = document.getElementById('reset-button');
            const sizeWarning = document.getElementById('size-warning');
            const bracket = document.getElementById('tournament-bracket');
            const winnerDisplay = document.getElementById('winner-display');
            const userIdDisplay = document.getElementById('user-id-display');

            // Removed CSV upload elements
            // const fileInput = document.getElementById('file-input');
            // const newCategoryNameInput = document.getElementById('new-category-name');
            // const uploadCategoryButton = document.getElementById('upload-category-button');
            // const uploadFeedback = document.getElementById('upload-feedback');

            // Gemini AI elements
            const aiCategoryPromptInput = document.getElementById('ai-category-prompt');
            const generateListButton = document.getElementById('generate-list-button');
            const generateFeedback = document.getElementById('generate-feedback');
            const generateSpinner = document.getElementById('generate-spinner');

            // Removed image display elements
            // const imageDisplayArea = document.getElementById('image-display-area');
            // const selectedItemName = document.getElementById('selected-item-name');
            // const selectedItemImage = document.getElementById('selected-item-image');
            // const itemDescriptionSpinner = document.getElementById('item-description-spinner');
            // const itemDescription = document.getElementById('item-description');


            let currentUserId = null;
            const appId = window.__app_id;

            // --- FUNCTIONS ---
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function validateTournamentSize() {
                const selectedCategory = categorySelect.value;
                if (!dishData.hasOwnProperty(selectedCategory)) {
                    sizeWarning.textContent = "Categoria selezionata non valida.";
                    sizeWarning.classList.remove('hidden');
                    startButton.disabled = true;
                    startButton.classList.add('opacity-50', 'cursor-not-allowed');
                    return;
                }

                const selectedSize = parseInt(sizeSelect.value);
                const availableItems = dishData[selectedCategory].length;

                if (selectedSize > availableItems) {
                    sizeWarning.textContent = `Attenzione: Non ci sono abbastanza elementi (${availableItems}) per questa dimensione del torneo (${selectedSize}) nella categoria selezionata.`;
                    sizeWarning.classList.remove('hidden');
                    startButton.disabled = true;
                    startButton.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    sizeWarning.classList.add('hidden');
                    startButton.disabled = false;
                    startButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            function createTournament(items, tournamentSize) {
                bracket.innerHTML = '';
                winnerDisplay.innerHTML = '';
                // imageDisplayArea.classList.add('hidden'); // Removed image display

                const competitors = shuffle([...items]).slice(0, tournamentSize);
                let numberOfRounds = Math.log2(tournamentSize);

                for (let i = 0; i < numberOfRounds; i++) {
                    const roundDiv = document.createElement('div');
                    roundDiv.className = `round round-${i+1}`;
                    if (i === numberOfRounds - 1) roundDiv.classList.add('final');

                    const roundTitle = document.createElement('h2');
                    roundTitle.className = 'text-xl md:text-2xl font-bold text-center mb-4 md:mb-6 title-font text-red-700';
                    roundTitle.textContent = roundTitles[i];
                    roundDiv.appendChild(roundTitle);
                    
                    const matchesInRound = tournamentSize / Math.pow(2, i+1);

                    for (let j = 0; j < matchesInRound; j++) {
                        const matchDiv = document.createElement('div');
                        matchDiv.className = 'match';
                        matchDiv.dataset.round = i;
                        matchDiv.dataset.match = j;

                        const matchPair = document.createElement('div');
                        matchPair.className = 'match-pair';

                        const competitor1 = document.createElement('div');
                        competitor1.className = 'competitor';
                        competitor1.dataset.competitorId = `r${i}m${j}c1`;

                        const vs = document.createElement('div');
                        vs.className = 'vs-separator';
                        vs.textContent = 'vs';

                        const competitor2 = document.createElement('div');
                        competitor2.className = 'competitor';
                        competitor2.dataset.competitorId = `r${i}m${j}c2`;

                        if (i === 0) {
                            competitor1.textContent = competitors[j * 2];
                            competitor2.textContent = competitors[j * 2 + 1];
                            competitor1.addEventListener('click', handleMatchClick);
                            competitor2.addEventListener('click', handleMatchClick);
                        } else {
                            competitor1.textContent = 'In attesa...';
                            competitor2.textContent = 'In attesa...';
                            competitor1.classList.add('placeholder');
                            competitor2.classList.add('placeholder');
                        }

                        matchPair.appendChild(competitor1);
                        matchPair.appendChild(vs);
                        matchPair.appendChild(competitor2);
                        matchDiv.appendChild(matchPair);
                        
                        // Add connectors
                        if (i < numberOfRounds - 1) {
                            const connector = document.createElement('div');
                            connector.className = 'match-connector';
                            matchDiv.appendChild(connector);

                            const baseMatchHeight = 70; // min-height of .match-pair
                            const matchMargin = 24; // margin-bottom of .match (12px top + 12px bottom)
                            const roundHeight = (baseMatchHeight + matchMargin) * Math.pow(2, i);
                            const connectorHeight = roundHeight - baseMatchHeight;

                            if (j % 2 === 0) {
                                const roundConnector = document.createElement('div');
                                roundConnector.className = 'round-connector';
                                roundConnector.style.height = `${connectorHeight + baseMatchHeight}px`;
                                roundConnector.style.top = `calc(50% - ${connectorHeight / 2}px)`;
                                matchDiv.appendChild(roundConnector);
                            }
                        }
                        
                        roundDiv.appendChild(matchDiv);
                    }
                    bracket.appendChild(roundDiv);
                }
            }

            function handleMatchClick(event) {
                const selected = event.currentTarget;
                const matchPair = selected.parentElement;
                
                if (matchPair.dataset.winner || selected.classList.contains('placeholder')) return;

                const competitors = Array.from(matchPair.getElementsByClassName('competitor'));
                const winner = selected;
                const loser = competitors.find(c => c !== winner);

                winner.classList.add('winner');
                loser.classList.add('loser');
                matchPair.dataset.winner = winner.textContent;

                // Removed image display and AI description call
                // displaySelectedItem(winner.textContent);

                advanceWinner(winner);
            }

            function advanceWinner(winner) {
                const matchPair = winner.parentElement;
                const matchDiv = matchPair.parentElement;
                const round = parseInt(matchDiv.dataset.round);
                const match = parseInt(matchDiv.dataset.match);

                const nextRound = round + 1;
                const nextMatch = Math.floor(match / 2);
                const isFirstInNextPair = match % 2 === 0;

                const nextMatchCompetitorSlotQuery = isFirstInNextPair ?
                    `[data-competitor-id="r${nextRound}m${nextMatch}c1"]` :
                    `[data-competitor-id="r${nextRound}m${nextMatch}c2"]`;

                const nextSlot = bracket.querySelector(nextMatchCompetitorSlotQuery);

                if (nextSlot) {
                    nextSlot.textContent = winner.textContent;
                    nextSlot.classList.remove('placeholder');

                    const opponentSlotQuery = isFirstInNextPair ?
                        `[data-competitor-id="r${nextRound}m${nextMatch}c2"]` :
                        `[data-competitor-id="r${nextRound}m${nextMatch}c1"]`;
                    const opponentSlot = bracket.querySelector(opponentSlotQuery);

                    if (opponentSlot && !opponentSlot.classList.contains('placeholder')) {
                        nextSlot.addEventListener('click', handleMatchClick);
                        opponentSlot.addEventListener('click', handleMatchClick);
                    }
                } else {
                    displayWinner(winner.textContent);
                }
            }

            function displayWinner(name) {
                const winnerDisplay = document.getElementById('winner-display');
                winnerDisplay.innerHTML = `
                    <div class="winner-trophy">
                        <h2 class="text-2xl md:text-3xl font-bold title-font text-amber-600">Vincitore del Torneo!</h2>
                        <p class="text-4xl md:text-5xl font-bold my-4 text-red-800" style="text-transform: capitalize;">${name}</p>
                        <div class="text-6xl md:text-7xl">🏆</div>
                    </div>
                `;
                // Removed image display
                // imageDisplayArea.classList.add('hidden'); // Hide image display once winner is declared
            }

            // Removed displaySelectedItem function


            // Function to add new data from CSV (still used by AI generation)
            async function addDataFromCSV(categoryName, itemsArray) { // Changed csvContent to itemsArray
                const uniqueItems = [...new Set(itemsArray)]; // Ensure uniqueness

                if (currentUserId) {
                    try {
                        const categoryRef = doc(db, `artifacts/${appId}/users/${currentUserId}/categories`, categoryName);
                        await setDoc(categoryRef, {
                            name: categoryName,
                            items: uniqueItems
                        });
                        // uploadFeedback.textContent = `Categoria "${categoryName}" caricata e salvata con successo!`; // Removed feedback element
                        // uploadFeedback.className = "text-sm mt-2 text-green-600";
                    } catch (e) {
                        // uploadFeedback.textContent = `Errore durante il salvataggio della categoria: ${e.message}`; // Removed feedback element
                        // uploadFeedback.className = "text-sm mt-2 text-red-500";
                        console.error("Error saving document: ", e);
                    }
                } else {
                    dishData[categoryName] = uniqueItems;
                    // uploadFeedback.textContent = `Categoria "${categoryName}" caricata (non salvata, utente non autenticato).`; // Removed feedback element
                    // uploadFeedback.className = "text-sm mt-2 text-orange-500";
                }
                // uploadFeedback.classList.remove('hidden'); // Removed feedback element
                updateCategorySelect();
            }

            // Update category select dropdown dynamically
            function updateCategorySelect() {
                const currentSelectedValue = categorySelect.value;
                categorySelect.innerHTML = '';
                for (const key in dishData) {
                    if (dishData.hasOwnProperty(key) && dishData[key].length > 0) { // Only add categories with items
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                        categorySelect.appendChild(option);
                    }
                }
                if (dishData.hasOwnProperty(currentSelectedValue)) {
                    categorySelect.value = currentSelectedValue;
                } else if (Object.keys(dishData).length > 0) {
                    categorySelect.value = Object.keys(dishData)[0]; // Select first available category
                } else {
                    categorySelect.innerHTML = '<option value="">Nessuna categoria disponibile</option>';
                    startButton.disabled = true;
                    startButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
                validateTournamentSize();
            }

            function initApp() {
                loadingScreen.classList.remove('hidden');
                startScreen.classList.add('hidden');
                tournamentContainer.classList.add('hidden');
                winnerDisplay.innerHTML = '';
                // Removed image display elements init
                // imageDisplayArea.classList.add('hidden');
                // selectedItemName.textContent = '';
                // selectedItemImage.src = '';
                // itemDescription.textContent = '';
                // itemDescriptionSpinner.classList.add('hidden');
                // Removed CSV upload elements init
                // uploadFeedback.classList.add('hidden');
                // fileInput.value = '';
                // newCategoryNameInput.value = '';
                aiCategoryPromptInput.value = ''; // Clear AI prompt input
                generateFeedback.classList.add('hidden'); // Hide AI feedback
                generateSpinner.classList.add('hidden'); // Hide AI spinner
                // Categories will be loaded by onAuthStateChanged listener
            }

            // --- Firebase Authentication and Data Loading ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = `ID Utente: ${currentUserId}`;
                    console.log("Authenticated as:", currentUserId);

                    // Load user-specific categories from Firestore
                    const categoriesColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);
                    onSnapshot(categoriesColRef, (snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            const categoryName = change.doc.id;
                            const categoryData = change.doc.data();
                            if (change.type === "added" || change.type === "modified") {
                                dishData[categoryName] = categoryData.items;
                                console.log(`Category ${categoryName} loaded/updated.`);
                            } else if (change.type === "removed") {
                                delete dishData[categoryName];
                                console.log(`Category ${categoryName} removed.`);
                            }
                        });
                        updateCategorySelect();
                        loadingScreen.classList.add('hidden');
                        startScreen.classList.remove('hidden');
                    }, (error) => {
                        console.error("Error listening to categories:", error);
                        loadingScreen.innerHTML = `<p class="text-red-500">Errore nel caricamento delle categorie: ${error.message}</p>`;
                    });

                } else {
                    // Sign in anonymously if no user is logged in
                    try {
                        if (window.__initial_auth_token) {
                            await signInWithCustomToken(auth, window.__initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                        loadingScreen.innerHTML = `<p class="text-red-500">Errore di autenticazione: ${error.message}</p>`;
                    }
                }
            });

            // --- Event Listeners ---
            startButton.addEventListener('click', function() {
                const selectedCategory = categorySelect.value;
                const selectedSize = parseInt(sizeSelect.value);
                
                if (selectedSize > dishData[selectedCategory].length) {
                    console.error("Not enough items for the selected tournament size in this category.");
                    return;
                }

                startScreen.classList.add('hidden');
                tournamentContainer.classList.remove('hidden');
                createTournament(dishData[selectedCategory], selectedSize);
            });

            resetButton.addEventListener('click', initApp);
            categorySelect.addEventListener('change', validateTournamentSize);
            sizeSelect.addEventListener('change', validateTournamentSize);

            // Removed CSV upload button listener and related functions
            // uploadCategoryButton.addEventListener('click', function() { /* ... */ });
            // function processFileUpload(file, categoryName) { /* ... */ }

            // --- Gemini AI List Generation ---
            generateListButton.addEventListener('click', async function() {
                const aiCategoryPrompt = aiCategoryPromptInput.value.trim();
                if (!aiCategoryPrompt) {
                    generateFeedback.textContent = "Inserisci un tipo di elementi da generare (es: città italiane).";
                    generateFeedback.className = "text-sm mt-2 text-red-500";
                    generateFeedback.classList.remove('hidden');
                    return;
                }

                generateFeedback.classList.add('hidden');
                generateSpinner.classList.remove('hidden');
                generateListButton.disabled = true;
                generateListButton.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    const prompt = `Genera una lista di 16 ${aiCategoryPrompt} famosi. Rispondi in formato JSON, un array di stringhe, dove ogni stringa è il nome di un elemento. Non aggiungere altro testo o formattazione oltre al JSON.`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: { "type": "STRING" }
                            }
                        }
                    };
                    const apiKey = ""; // Canvas will provide this
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        const generatedItems = JSON.parse(jsonString);

                        if (generatedItems && Array.isArray(generatedItems) && generatedItems.length > 0) {
                            const newCategoryName = `generati_${aiCategoryPrompt.replace(/\s+/g, '_').toLowerCase()}`;
                            await addDataFromCSV(newCategoryName, generatedItems); // Pass array directly
                            
                            generateFeedback.textContent = `Lista di "${aiCategoryPrompt}" generata e aggiunta come categoria "${newCategoryName}"!`;
                            generateFeedback.className = "text-sm mt-2 text-green-600";
                            aiCategoryPromptInput.value = ''; // Clear input
                            categorySelect.value = newCategoryName; // Select the new category
                            validateTournamentSize();
                        } else {
                            generateFeedback.textContent = "L'AI non ha generato una lista valida. Riprova con un prompt diverso.";
                            generateFeedback.className = "text-sm mt-2 text-orange-500";
                        }
                    } else {
                        generateFeedback.textContent = "Impossibile generare la lista. Riprova.";
                        generateFeedback.className = "text-sm mt-2 text-red-500";
                        console.error("Gemini API response structure unexpected for list generation:", result);
                    }
                } catch (error) {
                    generateFeedback.textContent = `Errore durante la generazione della lista: ${error.message}`;
                    generateFeedback.className = "text-sm mt-2 text-red-500";
                    console.error("Error calling Gemini API for list generation:", error);
                } finally {
                    generateSpinner.classList.add('hidden');
                    generateFeedback.classList.remove('hidden');
                    generateListButton.disabled = false;
                    generateListButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            // --- INITIALIZATION ---
            initApp();
        });
    </script>
</body>
</html>


